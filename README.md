# AVD 카카오톡 봇 (메신저봇R v39)

메신저봇R v39 (Android)에서 실행되는 카카오톡 봇 스크립트입니다. 백엔드 서버와 연동하여 일정 알림 및 명령어 처리를 수행합니다.

## ⚠️ 중요: 메신저봇R 버전

**권장 버전: v39 (0.7.39.x)**
- Play 스토어 버전(v29)은 레거시 버전으로 비권장
- kbotdocs.dev에서 최신 안정 버전 다운로드 권장
- 레거시 API 사용 (API2 아님)

## 프로젝트 구조

**⚠️ 중요: 메신저봇R은 `require()`를 지원하지 않으므로 모든 코드가 `bot.js` 하나로 통합되어 있습니다.**

```
AVD-KakaoBot/
├── README.md              ← 이 파일
└── bot.js                 ← 메인 스크립트 (단일 파일, 모든 기능 통합)
```

**실제 사용 파일**: `bot.js` 하나만 메신저봇R에 업로드하면 됩니다.

## 설치

### 1. 메신저봇R v39 설치
1. kbotdocs.dev → "메신저봇R" → "안정 버전" 다운로드
2. Play 스토어 버전은 사용하지 마세요 (레거시 버전)
3. APK 설치 후 알림 접근 권한 허용

### 2. 카카오톡 설정
- 카카오톡 로그인
- 알림 설정 활성화

### 3. 봇 스크립트 업로드
1. 메신저봇R 앱 실행
2. 새 봇 생성 (레거시 API 선택)
3. **`bot.js` 파일 복사/붙여넣기**
4. 설정 값 입력 (아래 참조)
5. 저장 및 컴파일
6. 봇 활성화 토글 ON

## 설정

### 1. bot.js 수정 (필수)

**⚠️ 중요: 봇 실행 전에 반드시 아래 두 값을 입력해야 합니다!**

`bot.js` 파일 상단의 `CONFIG` 객체에서 다음 두 값을 설정하세요:

```javascript
var CONFIG = {
  // 초기 연결용 서버 URL
  INITIAL_SERVER_URL: 'https://myteamdashboard.onrender.com',
  
  // 초기 연결용 봇 토큰 (백엔드 관리자에게 문의)
  INITIAL_BOT_TOKEN: 'your-token-here',
  
  // 디바이스 ID (다중 봇 운영 시 고유하게)
  DEVICE_ID: 'avd-bot-1',
  
  // Outbox 폴링 간격 (밀리초)
  POLL_INTERVAL_MS: 15000, // 15초
  
  // 한 번에 가져올 메시지 수
  PULL_LIMIT: 20,
  
  // 카톡 메시지 길이 제한
  MAX_MESSAGE_LENGTH: 3000,
  
  // HTTP 요청 타임아웃
  REQUEST_TIMEOUT_MS: 10000
};
```

**⚠️ 보안 주의**: GitHub에는 빈 값(`''`)으로 커밋되어 있습니다. 실행 전 반드시 입력하세요!

## 사용법

### 일반 명령어 (모든 사용자)
**⚠️ `/` prefix 필수!**

- `/일정` - 이번 달 일정 조회
- `/리스크` - 리스크 이슈 뉴스 조회
- `/제휴` - 제휴처 탐색 정보 조회
- `/기술` - 신기술 동향 조회
- `/뉴스` - 전체 뉴스 모니터링
- `/도움말` 또는 `/help` - 사용법 안내

**예시**: 카톡방에서 `/일정` 입력 → 일정 정보 표시

### 관리자 명령어 (`!` prefix)

- `!방이름` 또는 `!방정보` - 현재 방 이름 확인 (방 등록 전 필수!)
- `!방추가 <방이름>` - 새 방 추가
- `!방삭제 <방이름>` - 방 삭제
- `!방목록` - 전체 방 목록 조회
- `!상태` - 봇 연결 상태 확인
- `!서버테스트` - 서버 연결 테스트
- `!설정새로고침` - 설정 다시 로드
- `!폴링시작` - Outbox 폴링 시작
- `!폴링중지` - Outbox 폴링 중지
- `!폴링테스트` - 즉시 폴링 실행
- `!도움말` - 관리자 명령어 목록

**예시**: 
1. `!방이름` → 방 이름 확인
2. `!방추가 봉훈` → 방 등록

### 자동 알림

#### 1. 일정 변경 알림
백엔드에서 일정이 등록/변경/삭제되면 자동으로 카톡 방에 알림이 전송됩니다.
- 일정 등록 시: `[일정 등록]` 메시지
- 일정 변경 시: `[일정 변경]` 메시지
- 일정 취소 시: `[일정 취소]` 메시지

**조건**: 방의 `scheduleNotify=true` 설정 필요

#### 2. 매일 자동 발송
관리자 페이지에서 설정한 시간에 매일 일정+뉴스를 자동 발송합니다.
- 발송 시간: 관리자 페이지에서 설정 (예: 08:30)
- 대상: 일정알림(🔔)이 활성화된 모든 방
- 내용: 금일 일정 + 오늘의 뉴스 요약

## 작동 방식

### Outbox Pattern (비동기 큐)
1. 백엔드가 메시지 생성 시 BotOutbox에 적재
2. AVD봇이 **15초마다** `/api/bot/outbox/pull` 호출하여 메시지 가져오기
3. AVD봇이 카톡방에 메시지 전송
4. AVD봇이 `/api/bot/outbox/ack`로 전송 결과 보고
5. 실패 시 자동 재시도 (최대 5회, 지수 백오프)

### 폴링 주기
- **봇 폴링**: 15초마다 (CONFIG.POLL_INTERVAL_MS)
- **설정 동기화**: 1시간마다
- **메시지 생성**: 크론 작업 실행 시 즉시 Outbox 저장 (지연 없음)

### 재시도 정책
| 시도 | 대기 시간 | 누적 시간 |
|-----|----------|----------|
| 1차 실패 | 1분 | 1분 |
| 2차 실패 | 2분 | 3분 |
| 3차 실패 | 4분 | 7분 |
| 4차 실패 | 8분 | 15분 |
| 5차 실패 | 16분 | 31분 |
| 6차 이상 | 중단 | - |

## 문제 해결

### 초기 설정 오류
```
초기 설정 오류: INITIAL_SERVER_URL 또는 INITIAL_BOT_TOKEN이 설정되지 않았습니다.
```
**해결 방법**: `bot.js` 파일의 `CONFIG` 객체에서 `INITIAL_SERVER_URL`과 `INITIAL_BOT_TOKEN` 값을 입력하세요.

### 봇이 응답하지 않음
1. **봇 활성화 토글 확인**: 메신저봇R에서 토글이 ON인지 확인
2. **알림 접근 권한**: 안드로이드 설정 → 알림 접근 권한 → 메신저봇R 허용
3. **명령어 prefix 확인**: 일반 명령어는 `/` 필수, 관리자 명령어는 `!` 필수
4. **방 등록 확인**: `!방목록`으로 방이 등록되어 있고 `enabled=true`인지 확인

### 연결 안 됨
1. `CONFIG`의 `INITIAL_SERVER_URL` 확인
2. 백엔드 서버 실행 여부 확인
3. `INITIAL_BOT_TOKEN` 일치 여부 확인 (백엔드 `.env`의 `BOT_API_TOKEN`과 동일해야 함)
4. `!서버테스트` 명령어로 연결 확인

### 메시지 안 전송
1. 방 설정 확인 (`!방목록` 명령어로 확인)
   - `enabled=true` 확인
   - `scheduleNotify=true` 확인 (일정 알림의 경우)
2. 카톡 방 이름 정확히 일치하는지 확인 (`!방이름`으로 확인)
3. 봇 폴링 상태 확인 (`!상태` 명령어)
4. 백엔드 로그 확인 (관리자 페이지 → 발송 현황)

### 관리자 명령어 작동 안 함
1. 백엔드 Setting 컬렉션에서 `kakao_admins` 확인
2. 카톡 닉네임이 정확히 일치하는지 확인
3. 봇 재시작 후 재시도

## 기술 스택

- **언어**: JavaScript (ES5)
- **실행 환경**: 메신저봇R v39 (Rhino 엔진)
- **API**: 레거시 API (`response` 함수)
- **HTTP 클라이언트**: java.net.HttpURLConnection
- **아키텍처**: Outbox Pattern (비동기 큐)
- **구조**: 단일 파일 (메신저봇R의 require() 미지원 대응)

## 제약사항

메신저봇R은 Rhino 엔진을 사용하므로 다음 제약사항이 있습니다:
- ES5 문법만 사용 가능 (`var`, `function`)
- Arrow function 사용 불가 (`=>`)
- `let`, `const` 사용 불가
- `async/await` 사용 불가
- 외부 npm 패키지 사용 불가
- `require()` 상대 경로 미지원

## 보안

- ✅ **GitHub 안전**: `INITIAL_SERVER_URL`과 `INITIAL_BOT_TOKEN`은 빈 값으로 설정되어 있어 GitHub에 민감 정보가 노출되지 않습니다
- ⚠️ **사용자 책임**: 봇 실행 전 사용자가 직접 두 값을 입력해야 합니다
- 🔒 **토큰 관리**: 
  - 토큰은 백엔드 관리자에게 문의하여 받으세요
  - 토큰을 다른 사람과 공유하지 마세요
  - 토큰 노출 시 즉시 재발급하세요
- 📝 **Git 커밋 시 주의**: 
  - 토큰 입력 후 `bot.js`를 커밋하지 마세요
  - `.gitignore`에 설정 파일을 추가하거나, 커밋 전 토큰을 제거하세요

## 버전 히스토리

### v1.0 (2026-01-19)
- ✅ 메신저봇R v39 기반 제로베이스 재구축
- ✅ 레거시 API 사용
- ✅ `/` prefix 일반 명령어 지원
- ✅ `!` prefix 관리자 명령어 지원
- ✅ Outbox 폴링 (15초 주기)
- ✅ 매일 자동 발송 지원
- ✅ 일정 변경 자동 알림
- ✅ java.net.HttpURLConnection 사용 (안정성 향상)

## 라이센스

이 프로젝트는 팀 내부용으로 제작되었습니다.

## 문의

기술 지원이 필요한 경우 개발팀에 문의하세요.

---

**작성일**: 2026년 1월 19일  
**최종 업데이트**: 2026년 1월 19일  
**버전**: 1.0  
**메신저봇R 버전**: v39 (권장)
