# AVD 카카오톡 봇 (메신저봇R)

메신저봇R (Android)에서 실행되는 카카오톡 봇 스크립트입니다. 백엔드 서버와 연동하여 일정 알림 및 명령어 처리를 수행합니다.

## 프로젝트 구조

```
AVD-KakaoBot/
├── README.md              ← 이 파일
├── bot.js                 ← 메인 엔트리 포인트 (메신저봇R)
├── config.js              ← 설정 파일
├── handlers/
│   ├── commandHandler.js  ← 일반 명령 처리
│   ├── adminHandler.js    ← 관리자 명령 처리
│   └── outboxHandler.js   ← Outbox 폴링/전송/ACK
└── utils/
    ├── api.js             ← HTTP 요청 유틸리티
    ├── messageFormatter.js ← 메시지 분할/포맷팅
    └── logger.js          ← 로깅 유틸리티
```

## 설치

### 1. Android Studio에서 AVD 생성
- API Level: 28 이상 (Android 9.0+)
- RAM: 2GB 이상
- 내부 저장소: 4GB 이상

### 2. 메신저봇R 설치
1. AVD에서 메신저봇R APK 설치
2. 접근성 권한 부여
3. 카카오톡 로그인

### 3. 봇 스크립트 업로드
1. 메신저봇R 앱 실행
2. 프로젝트 생성 또는 기존 프로젝트 선택
3. 모든 `.js` 파일을 프로젝트에 복사

## 설정

### 1. config.js 수정 (선택사항)

**중요**: `SERVER_URL`과 `BOT_TOKEN`은 서버에서 자동으로 받아오므로 설정 불필요합니다.

필요한 경우 다음 설정만 변경하세요:

```javascript
module.exports = {
  // SERVER_URL과 BOT_TOKEN은 서버 API에서 받아옴
  
  // 디바이스 ID (다중 봇 운영 시 고유하게)
  DEVICE_ID: 'avd-bot-1',  // 원하는 ID로 변경
  
  // Outbox 폴링 간격 (밀리초)
  POLL_INTERVAL_MS: 15000, // 기본값: 15초
  
  // 한 번에 가져올 메시지 수
  PULL_LIMIT: 20,
  
  // 카톡 메시지 길이 제한
  MAX_MESSAGE_LENGTH: 3000,
  
  // HTTP 요청 타임아웃
  REQUEST_TIMEOUT_MS: 10000
};
```

### 2. 백엔드 설정 확인
백엔드 `.env` 파일에 다음 환경변수가 설정되어 있어야 합니다:
```bash
SERVER_URL=https://myteamdashboard.onrender.com
BOT_API_TOKEN=your-secret-token-here
```

봇은 시작 시 `/api/bot/config` API를 호출하여 `serverUrl`과 `botToken`을 자동으로 받아옵니다.

## 사용법

### 일반 명령어 (모든 사용자)
- `리스크` - 리스크 이슈 뉴스 조회
- `제휴` - 제휴처 탐색 정보 조회
- `기술` - 신기술 동향 조회
- `일정` - 이번 달 일정 조회
- `뉴스` - 전체 뉴스 모니터링
- `도움말` - 사용법 안내

### 관리자 명령어
- `!방추가 <방이름>` - 새 방 추가
- `!방삭제 <방이름>` - 방 삭제
- `!방 on <방이름>` - 방 활성화
- `!방 off <방이름>` - 방 비활성화
- `!일정알림 on <방이름>` - 일정 알림 ON
- `!일정알림 off <방이름>` - 일정 알림 OFF
- `!명령 on <방이름>` - 명령 응답 ON
- `!명령 off <방이름>` - 명령 응답 OFF
- `!방목록` - 전체 방 목록 조회
- `!상태` - 봇 연결 상태 확인

### 자동 알림
백엔드에서 일정이 등록/변경/삭제되면 자동으로 카톡 방에 알림이 전송됩니다.
- 일정 등록 시: `[일정 등록]` 메시지
- 일정 변경 시: `[일정 변경]` 메시지
- 일정 삭제 시: `[일정 취소]` 메시지

## 작동 방식

### Outbox Pattern (비동기 큐)
1. 백엔드가 일정 변경 시 BotOutbox에 메시지 적재
2. AVD봇이 15초마다 `/api/bot/outbox/pull` 호출하여 메시지 가져오기
3. AVD봇이 카톡방에 메시지 전송
4. AVD봇이 `/api/bot/outbox/ack`로 전송 결과 보고
5. 실패 시 자동 재시도 (최대 5회, 지수 백오프)

### 재시도 정책
| 시도 | 대기 시간 | 누적 시간 |
|-----|----------|----------|
| 1차 실패 | 1분 | 1분 |
| 2차 실패 | 2분 | 3분 |
| 3차 실패 | 4분 | 7분 |
| 4차 실패 | 8분 | 15분 |
| 5차 실패 | 16분 | 31분 |
| 6차 이상 | 중단 | - |

## 문제 해결

### 연결 안 됨
1. `config.js`의 `SERVER_URL` 확인
2. 백엔드 서버 실행 여부 확인
3. `BOT_TOKEN` 일치 여부 확인
4. 방화벽 설정 확인

### 메시지 안 전송
1. 방 설정 확인 (`!방목록` 명령어로 확인)
   - `enabled=true` 확인
   - `scheduleNotify=true` 확인 (일정 알림의 경우)
2. 카톡 방 이름 정확히 일치하는지 확인
3. 백엔드 로그 확인 (`/api/bot/outbox/stats`)

### 관리자 명령어 작동 안 함
1. 백엔드 Setting 컬렉션에서 `kakao_admins` 확인
2. 카톡 닉네임이 정확히 일치하는지 확인
3. 봇 재시작 후 재시도

### 설정 동기화 안 됨
- 봇은 1시간마다 자동으로 설정을 동기화합니다
- 즉시 동기화가 필요한 경우 봇을 재시작하세요

## 기술 스택

- **언어**: JavaScript (ES5)
- **실행 환경**: 메신저봇R (Rhino 엔진)
- **HTTP 클라이언트**: org.jsoup.Jsoup
- **아키텍처**: Outbox Pattern (비동기 큐)

## 제약사항

메신저봇R은 Rhino 엔진을 사용하므로 다음 제약사항이 있습니다:
- ES5 문법만 사용 가능 (`var`, `function`)
- Arrow function 사용 불가 (`=>`)
- `let`, `const` 사용 불가
- `async/await` 사용 불가
- 외부 npm 패키지 사용 불가

## 보안

- ✅ **개선**: `BOT_TOKEN`과 `SERVER_URL`은 코드에 포함되지 않고 서버에서 동적으로 받아옵니다
- 백엔드 `.env` 파일은 `.gitignore`에 추가하세요
- 토큰 노출 시 즉시 재발급하세요
- 관리자 닉네임은 신중하게 관리하세요
- AVD 봇 코드는 민감 정보가 없어 GitHub에 안전하게 공개 가능합니다

## 라이센스

이 프로젝트는 팀 내부용으로 제작되었습니다.

## 문의

기술 지원이 필요한 경우 개발팀에 문의하세요.

---

**작성일**: 2026년 1월 15일  
**버전**: 1.0  
**담당**: Sonnet 4.5
